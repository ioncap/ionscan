#!/usr/bin/env bash

# ==============================================================================
#  IONSCAN v23.0 - THE FRAMEWORK EDITION
# ==============================================================================
#
#  Main entry point for the IonScan framework.
#  This script sources libraries and modules, then starts the interactive shell.
#
# ==============================================================================

# --- SOURCE FRAMEWORK ---
INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd)"

# Libraries
source "$INSTALL_DIR/lib/ui.sh"
source "$INSTALL_DIR/lib/core.sh"
source "$INSTALL_DIR/lib/network.sh"

# --- MODULE SOURCING ---
# We will source modules as they are 'used' in the new interactive shell.
# This makes the shell start faster and is more dynamic.

# --- STATE VARIABLES ---
# Global variables to manage the shell's state
CURRENT_MODULE=""
declare -A MODULE_OPTIONS

# --- COMMAND HANDLERS ---

cmd_help() {
    echo -e "${BOLD}IonScan Interactive Shell${NC}"
    echo "========================="
    echo "Core Commands:"
    echo "  help              Show this help message"
    echo "  show modules      List all available modules"
    echo "  use <module>      Select a module to use (e.g., 'use recon')"
    echo "  show options      Show options for the current module"
    echo "  set <key> <val>   Set an option for the current module (e.g., 'set TARGET 192.168.1.1')"
    echo "  run               Run the current module"
    echo "  back              Deselect the current module"
    echo "  exit              Exit IonScan"
    echo ""
}

cmd_exit() {
    log_info "Exiting IonScan. Goodbye!"
    exit 0
}

cmd_show() {
    local sub_cmd="$1"
    case "$sub_cmd" in
        modules)
            echo -e "${BOLD}Available Modules:${NC}"
            echo "===================="
            
            local modules_dir="$INSTALL_DIR/modules"
            local files=$(find "$modules_dir" -type f -name "*.sh")
            
            # Simple list for now. We can categorize later.
            for file in $files; do
                local module_name=$(basename "$file" .sh)
                echo "  - $module_name"
            done
            echo ""
            ;;
        options)
            # To be implemented
            log_warning "Command 'show options' is not yet implemented."
            ;;
        *)
            log_error "Unknown 'show' command: '$sub_cmd'. Try 'show modules'."
            ;;
    esac
}

cmd_use() {
    local module_name="$1"
    local module_path="$INSTALL_DIR/modules/${module_name}.sh"

    if [[ -f "$module_path" ]]; then
        source "$module_path"
        
        case "$module_name" in
            recon)
                menu_recon
                ;;
            wireless)
                menu_wireless
                ;;
            exploit)
                menu_exploit
                ;;
            utils)
                menu_utils
                ;;
            report)
                mod_report
                ;;
            *)
                log_error "Module '$module_name' does not have a main menu function."
                ;;
        esac
    else
        log_error "Module '$module_name' not found."
    fi
}


# --- INTERACTIVE SHELL ---
interactive_shell() {
    while true; do
        # Build the prompt
        local prompt="${CYAN}ionscan${NC}"
        # The context-sensitive prompt is removed for now, as 'use' directly enters a menu
        prompt+=" > "

        # Read user input
        read -rp "$(echo -e "$prompt")" line

        # Add to history
        if [[ -n "$line" ]]; then
            history -s "$line"
        fi

        # Parse command and arguments
        local cmd; read -r cmd args <<< "$line"

        # Dispatch command
        case "$cmd" in
            help|?)
                cmd_help
                ;;
            show)
                cmd_show "$args"
                ;;
            use)
                cmd_use "$args"
                ;;
            exit|quit)
                cmd_exit
                ;;
            "") # Empty command
                ;;
            *)
                log_error "Unknown command: '$cmd'. Type 'help' for a list of commands."
                ;;
        esac
    done
}


# --- MAIN ENTRY ---
main() {
    setup_config

    # --- Argument Parsing (getopt) ---
    # ... This will be re-integrated later ...

    # If no arguments are given, start the interactive shell
    if [[ $# -eq 0 ]]; then
        header # Display header once on start
        # Disclaimer check
        if [[ "${AGREED:-}" != "true" ]]; then
            echo -e "${RED}${BOLD}DISCLAIMER${NC}"
            echo "This tool is for educational and authorized use only."
            read -rp "Do you agree? [y/N] " A
            if [[ ! "$A" =~ ^[Yy]$ ]]; then exit 1; fi
        fi
        interactive_shell
    fi

    # Handle non-interactive command-line arguments (to be re-added)
    # ...
}

main "$@"
