#!/usr/bin/env bash

# ==============================================================================
#  IONSCAN v22.0 - GIT EDITION
# ==============================================================================
#
#  Main entry point for the IonScan framework.
#  This script sources libraries and modules, then displays the main menu.
#
# ==============================================================================

# --- SOURCE FRAMEWORK ---
INSTALL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../" && pwd)"

# Libraries
source "$INSTALL_DIR/lib/ui.sh"
source "$INSTALL_DIR/lib/core.sh"
source "$INSTALL_DIR/lib/network.sh"

# Function to check if a module is enabled
is_module_enabled() {
    local module_name="$1"
    local setting_name="MODULE_${module_name}_ENABLED"
    local setting_value=$(get_config "$setting_name")
    [[ "$setting_value" == "true" ]]
}

# Conditionally source modules
if is_module_enabled "RECON"; then
    source "$INSTALL_DIR/modules/recon.sh"
fi
if is_module_enabled "WIRELESS"; then
    source "$INSTALL_DIR/modules/wireless.sh"
fi
if is_module_enabled "EXPLOIT"; then
    source "$INSTALL_DIR/modules/exploit.sh"
fi
if is_module_enabled "UTILS"; then
    source "$INSTALL_DIR/modules/utils.sh"
fi
# Report module is always sourced as it's a core component, but its menu entry can be disabled.
source "$INSTALL_DIR/modules/report.sh"


# --- MENUS ---
menu_recon() {
    while true; do
        header; echo -e "${CYAN}RECONNAISSANCE${NC}"
        echo "  [1] Passive Listener (Ghost)"
        echo "  [2] Fast Port Scan"
        echo "  [3] DNS Enumerator"
        echo "  [4] Web Spider"
        echo "  [5] mDNS Discovery"
        echo "  [6] SNMP Walker"
        echo "  [7] NetBIOS Scan"
        echo "  [0] Back"
        echo ""; read -rp "recon> " c
        case $c in
            1) mod_passive ;; 2) mod_fast_scan ;; 3) mod_dns ;; 4) mod_web ;;
            5) mod_mdns ;; 6) mod_snmp ;; 7) mod_netbios ;; 0) return ;;
        esac
    done
}

menu_wireless() {
    while true; do
        header; echo -e "${CYAN}WIRELESS / RF${NC}"
        echo "  [1] WiFi Monitor"
        echo "  [2] Bluetooth Scan"
        echo "  [0] Back"
        echo ""; read -rp "wireless> " c
        case $c in
            1) mod_wifi ;; 2) mod_bt ;; 0) return ;;
        esac
    }
}

menu_exploit() {
    while true; do
        header; echo -e "${CYAN}VULN & EXPLOIT${NC}"
        echo "  [1] Vuln Hunter (Phased)"
        echo "  [2] Zombie Hunter"
        echo "  [3] Gatekeeper (Brute)"
        echo "  [4] Cred Sniffer"
        echo "  [5] MSF Bridge"
        echo "  [6] Shell Listener"
        echo "  [7] Interceptor (MITM)"
        echo "  [0] Back"
        echo ""; read -rp "exploit> " c
        case $c in
            1) mod_vuln ;; 2) mod_zombie ;; 3) mod_brute ;; 4) mod_sniff ;;
            5) mod_msf ;; 6) mod_listener ;; 7) mod_intercept ;; 0) return ;;
        esac
    done
}

menu_utils() {
    while true; do
        header; echo -e "${CYAN}UTILITIES${NC}"
        echo "  [1] Identity Shifter"
        echo "  [2] ARP Watch"
        echo "  [3] SSL Inspector"
        echo "  [4] Payload Mule"
        echo "  [5] Decoy Swarm"
        echo "  [6] Auto-Scheduler"
        echo "  [0] Back"
        echo ""; read -rp "utils> " c
        case $c in
            1) mod_mac ;; 2) mod_arp ;; 3) mod_ssl ;; 4) mod_serve ;;
            5) mod_decoy ;; 6) mod_cron ;; 0) return ;;
        esac
    done
}

# --- MAIN ENTRY ---
main() {
    setup_config

    # Argument Parsing with getopt
    # Short options: a (auto), s (setup), h (help), g (agree), i (silent)
    # Long options: auto, setup, help, agree, silent
    ARGS=$(getopt -o ashi -l auto,setup,help,agree,silent -- "$@")
    if [[ $? -ne 0 ]]; then
        show_help
        exit 1
    fi
    eval set -- "$ARGS"

    while true; do
        case "$1" in
            -a|--auto)
                exec 200>"$LOCK_FILE"; flock -n 200 || exit 1
                check_deps "silent"; get_interface
                timeout 30s tcpdump -i "$DEFAULT_IFACE" -n -e "arp or udp port 5353" -w "$LOG_DIR/live_traffic.pcap" 2>/dev/null
                mod_report "--auto"
                exit 0
                ;;
            -s|--setup)
                run_setup_wizard
                exit 0 # exit after setup, as it usually involves installs/restarts
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -g|--agree)
                AGREED=true
                shift
                ;;
            -i|--silent)
                SILENT=true
                shift
                ;;
            --)
                shift
                break
                ;;
            *)
                log_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done

    check_deps

    # Disclaimer
    if [[ "${AGREED:-}" != "true" ]]; then
        header
        echo -e "${RED}${BOLD}DISCLAIMER${NC}"
        echo "This tool is for educational purposes only."
        read -rp "Do you agree? [y/N] " A
        if [[ ! "$A" =~ ^[Yy]$ ]]; then exit 1; fi
    fi

    local menu_option_counter=1
    while true; do
        header
        local menu_choices=()
        if is_module_enabled "RECON"; then
            echo -e "  [${menu_option_counter}] Network Reconnaissance"
            menu_choices+=("$menu_option_counter) menu_recon")
            ((menu_option_counter++))
        fi
        if is_module_enabled "WIRELESS"; then
            echo -e "  [${menu_option_counter}] Wireless Operations"
            menu_choices+=("$menu_option_counter) menu_wireless")
            ((menu_option_counter++))
        fi
        if is_module_enabled "EXPLOIT"; then
            echo -e "  [${menu_option_counter}] Vulnerability & Exploitation"
            menu_choices+=("$menu_option_counter) menu_exploit")
            ((menu_option_counter++))
        fi
        if is_module_enabled "UTILS"; then
            echo -e "  [${menu_option_counter}] Utilities"
            menu_choices+=("$menu_option_counter) menu_utils")
            ((menu_option_counter++))
        fi
        if is_module_enabled "REPORT"; then
            echo -e "  [${menu_option_counter}] Generate Report"
            menu_choices+=("$menu_option_counter) mod_report")
            ((menu_option_counter++))
        fi
        echo -e "  [0] Exit"
        echo ""
        read -rp "ionscan> " c

        local selected_action=""
        for choice in "${menu_choices[@]}"; do
            local num="${choice%%)*}"
            local func="${choice#*)}"
            if [[ "$num" == "$c" ]]; then
                selected_action="$func"
                break
            fi
        done

        case "$c" in
            0) exit 0 ;;
            *)
                if [[ -n "$selected_action" ]]; then
                    $selected_action
                else
                    log_warning "Invalid option."
                fi
                ;;
        esac
    done
}

main "$@"
